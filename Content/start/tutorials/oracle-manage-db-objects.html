<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:searchable="False">
    <head><title><MadCap:variable name="Heading.Level1" /></title>
        <link rel="canonical" href="https://docs.liquibase.com/start/tutorials/oracle-manage-db-objects.html" />
		<meta name="description" content="This page is a Liquibase tutorial that shows you how to manage your database objects using the Oracle database and some Oracle tools." />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
    </head>
    <body>
        <h1>Managing Database Objects using Oracle</h1>
        <p>This is a <MadCap:variable name="General.Liquibase" /> tutorial that shows you how to manage your database objects using the Oracle database and some Oracle tools. It also shows how branching and merging is performed using Subversion. The tutorial incorporates several best practices. This makes it realistic for the needs of a software development shop. If your needs are simpler, you can just use the best practices and conventions that apply to your situation.</p>
        <p>The scenario we will be using for the tutorial assumes we are developing an application for two customers named Solo and Duplex. Each customer has their own upgrade timing.</p>
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Solo</th>
                    <th>Duplex</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>t1 </td>
                    <td>install r1.0</td>
                    <td> </td>
                </tr>
                <tr>
                    <td>t2 </td>
                    <td>patch to r1.1</td>
                    <td> </td>
                </tr>
                <tr>
                    <td>t3 </td>
                    <td>upgrade to r2.0</td>
                    <td>install r2.0</td>
                </tr>
            </tbody>
        </table>
        <p>During the life cycle of an application, the development team may produce thousands of database changes. Periodically, we will want to consolidate these changes so that a fresh install can be done rapidly (also essential for the continuous integration environment), and so that we can ship a smaller set of changes to customers for upgrading.</p>
        <p>The chosen strategy is to clean up the <MadCap:variable name="General.changelog" /> for every major release. This means that customers will have to upgrade to major releases separately. I.e. to upgrade from release 1.0 to release 3.0 they will also have to install 2.0. A delivery for version X (this includes versions X.y) always consists of 3 parts:</p>
        <table>
            <thead>
                <tr>
                    <th>Script</th>
                    <th>Description</th>
                    <th>Create</th>
                    <th>Upgrade from X-1</th>
                    <th>Apply latest changes to version</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>lb_install</code>
                    </td>
                    <td>Perform fresh install for version X</td>
                    <td>X</td>
                    <td>
                    </td>
                    <td>X</td>
                </tr>
                <tr>
                    <td><code>lb_upgrade_to_major</code>
                    </td>
                    <td>Upgrade from (X-1) to X</td>
                    <td>
                    </td>
                    <td>X</td>
                    <td>X</td>
                </tr>
                <tr>
                    <td><code>lb_update</code>
                    </td>
                    <td>Upgrade within same major version, such as 1.1 to 1.5</td>
                    <td>
                    </td>
                    <td>
                    </td>
                    <td>X</td>
                </tr>
            </tbody>
        </table>
        <p>The directory structure we will build during this tutorial is shown below (assuming that we are delivering version 5.x). Instead of using a Subversion server, we will use a local repository in the <code>repo</code> directory.</p><pre xml:space="preserve"><code class="language-text">D:\projects
    +-- lbdemo
          +-- repo           &lt;-- Subversion repository
          +-- trunk          &lt;-- Working directory
                +-- install  &lt;-- Installation changelogs
                +-- latest   &lt;-- Changelogs for replaceable objects (packages, triggers, views)
                +-- v004     &lt;-- Changelogs to upgrade from version 4.0
                +-- v005     &lt;-- Changelogs to upgrade from version 5.0</code></pre>
        <p><b>lb_install:</b> A fresh install for version 5.0 will run:</p>
        <ul>
            <li>the <MadCap:variable name="General.changelog" />s in <code>install</code></li>
            <li>the <MadCap:variable name="General.changelog" />s in <code>latest</code> creating "replaceable" objects
            </li>
        </ul>
        <p><b>lb_upgrade_to_major:</b> An upgrade from version 4.x to 5.0 will run:</p>
        <ul>
            <li>the <MadCap:variable name="General.changelog" />s in <code>v004</code></li>
            <li>the <MadCap:variable name="General.changelog" />s in <code>v005</code></li>
        </ul>
        <p><b>lb_update:</b> An update from version 5.x will run:</p>
        <ul>
            <li>the <MadCap:variable name="General.changelog" />s in <code>v005</code></li>
        </ul>
        <p>The scenario for this tutorial is illustrated in the diagram below. Each of the blue boxes is a Subversion revision. The contents of a box is the commit message which describes the change.</p>
        <p style="text-align: center;">
            <img src="../../Z_Resources/Images/Screenshots/workflows/tutorial-overview.png" />
        </p>
        <h2><a>Step 1: Install the software</a>
        </h2>
        <h3><a>Install Oracle Database</a>
        </h3>
        <p>If you don't already have an Oracle database available, download Oracle XE from the <a href="https://oracle.com/xe" title="http://www.oracle.com/technology" rel="nofollow" alt="http://www.oracle.com/technology">Oracle Database XE</a> page and install it on your computer. The XE edition of the database is free to use for development and production purposes.</p>
        <h3><a>Install SQL Developer</a>
        </h3>
        <p>There are many tools available to manage your database objects. If you don't already have such a tool,  take a look at <acronym title="Structured Query Language">SQL</acronym> Developer. SQL Developer is available as a free download at the <a href="https://oracle.com/sqldeveloper" title="http://www.oracle.com/technology" rel="nofollow" alt="http://www.oracle.com/technology">Oracle SQL Developer</a> page.</p>
        <h3><a>Install JDeveloper</a>
        </h3>
        <p>Oracle JDeveloper is another free tool available from the <a href="http://www.oracle.com/technology" title="http://www.oracle.com/technology" rel="nofollow">Oracle Technology Network</a>. It has many features, including the <acronym title="Extensible Markup Language">XML</acronym> editor. This editor is schema-aware, and makes it easy to author your <MadCap:variable name="General.changelog" />s.</p>
        <p>After downloading and installing, start JDeveloper. If you are behind a proxy, configure the proxy using Tools &gt; Preferences &gt; Web Browser and Proxy.</p>
        <p>Next we will add the <MadCap:variable name="General.Liquibase" /> <acronym title="XML (Extensible Markup Language) Schema Definition">XSD</acronym> so that the editor becomes aware of the <MadCap:variable name="General.Liquibase" /> schema. Choose Tools &gt; Preferences &gt; <acronym title="Extensible Markup Language">XML</acronym> Schemas. Select <code>add</code>. Enter:</p>
        <table>
            <tbody>
                <tr>
                    <th>Schema:</th>
                    <td>http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd</td>
                </tr>
                <tr>
                    <th>Extension:</th>
                    <td>xml</td>
                </tr>
            </tbody>
        </table>
        <p>Press OK and now your JDeveloper is ready to edit your <MadCap:variable name="General.changelog" />s. There is no need to create an application or a project. Simply open the XML file you want to edit.</p>
        <h3><a>Install TortoiseSVN</a>
        </h3>
        <p>TortoiseSVN is a graphical front end to Subversion. It also has the capability to create a file based repository. We will use this feature for this tutorial. There is no need for you to have access to a Subversion server. Download TortoiseSVN from <a href="http://tortoisesvn.net/" title="http://tortoisesvn.net/" rel="nofollow">http://tortoisesvn.net/</a>. Install it and reboot your PC.</p>
        <h3><a>Create directory structure and Subversion repository</a>
        </h3>
        <p>Create the directory structure for this tutorial.</p><pre xml:space="preserve"><code class="language-text">D:
mkdir D:\projects\lbdemo\repo</code></pre>
        <p>In Windows Explorer, right-click on directory repo and choose <b>TortoiseSVN &gt; Create repository here</b>. We have now created a Subversion repository.</p>
        <p>Right-click on the directory repo again, and choose <b>TortoiseSVN &gt; Repo-browser</b>. The browser displays in a window similar to Windows Explorer. Right-click on the repo directory and choose <b>Create folder ..</b>. Enter the name <code>trunk</code>. You will then be prompted for a comment before you commit this change. Enter any comment.</p>
        <p>Repeat this to create folders <code>branches</code> and <code>tags</code>.</p>
        <p>You should end up with a repository structure that looks like this:</p><pre xml:space="preserve"><code class="language-text">file:///D:/projects/lbdemo/repo
  +- branches
  +- tags
  +- trunk</code></pre>
        <p>Close the repository browser.</p>
        <p>Return to Windows Explorer, navigate to directory <code>D:\projects\lbdemo</code> and right-click in the right panel. Choose <b>SVN Checkout</b>. In the panel that appears, enter:</p>
        <table>
            <tr>
                <th>
                    <acronym title="Uniform Resource Locator">URL</acronym> of repository: </th>
                <td><code>file:///D:/projects/lbdemo/repo/trunk</code>
                </td>
            </tr>
            <tr>
                <th>Checkout directory: </th>
                <td><code>D:\projects\lbdemo\trunk</code>
                </td>
            </tr>
        </table>
        <p>Press OK. A confirmation window will display to create directory trunk. Select Yes. Press OK. In Windows Explorer, the trunk directory will be displayed with a green icon, indicating that it is a working copy with no changes to commit.</p>
        <h3><a>Install the JDBC Driver</a>
        </h3>
        <p>Download the <a href="https://www.oracle.com/database/technologies/appdev/jdbc-downloads.html">Oracle JDBC driver</a>. Click on the link for 10g Release 2 drivers, and choose <code>ojdbc14.jar</code>.</p>
        <p>Save the jar in directory: <code>D:\projects\lbdemo</code>.</p>
        <h3><a>Install <MadCap:variable name="General.Liquibase" /></a>
        </h3>
        <p>Install <MadCap:variable name="General.Liquibase" /> following the instructions.</p>
        <p>Add the directory containing the <code>Liquibase.bat</code> file to your PATH. You can use the standard process in Windows or use a tool like <a href="http://redmondlab.net" title="http://redmondlab.net" rel="nofollow">Redmond Path</a>.</p>
        <p>Test the installation by opening a DOS box in the <code>D:\projects\lbdemo\trunk</code> directory and entering the following command:</p><pre xml:space="preserve"><code class="language-text">liquibase --version</code></pre>
        <p>The result should be something like: <code>Liquibase Version: 1.9.0</code></p>
        <p>Create a file named <code>liquibase.properties.template</code> in the <code>trunk</code> directory with the following contents:</p><pre xml:space="preserve"><code class="language-text">#liquibase.properties
driver: oracle.jdbc.OracleDriver
classpath: ../ojdbc14.jar
url: jdbc:oracle:thin:@localhost:1521/XEPDB1
username: tbd
password: tbd</code></pre>
        <p class="note" MadCap:autonum="&lt;b&gt;Note: &lt;/b&gt;">the classpath is relative to the current directory.</p>
        <p>Copy this file to the <MadCap:variable name="General.Liquibase" /> properties file and edit the last two lines as follows:</p><pre xml:space="preserve"><code class="language-text">#liquibase.properties
driver: oracle.jdbc.OracleDriver
classpath: ../ojdbc14.jar
url: jdbc:oracle:thin:@localhost:1521/XEPDB1
username: lb_dev
password: lb_dev</code></pre>
        <p>This properties file will save you from specifying these parameters on the command line every time you run a command. We will check the template file into subversion. We will store the file with the real connection details locally.</p>
        <p>Right-click the <MadCap:variable name="General.Liquibase" /> properties file and select <b>TortoiseSVN &gt; Add to ignore list &gt; &lt;properties-file&gt;</b>.</p>
        <p>Right-click <code>liquibase.properties.template</code> and select <b>TortoiseSVN &gt; Add</b>.</p>
        <p>Right-click the <code>trunk</code> directory and select <b>TortoiseSVN &gt; commit</b>.</p>
        <h2><a>Step 2: Create the initial database schemas</a>
        </h2>
        <p>For our tutorial, we will create these database schemas:</p>
        <ul>
            <li><b>lb_dev</b> – our development environment</li>
            <li><b>lb_test</b> – our test environment</li>
            <li><b>lb_solo</b> – the environment of customer Solo</li>
            <li><b>lb_duplex</b> – the environment of customer Duplex</li>
        </ul>
        <p>Open SQL Developer and create a connection to your database using the "system" username. You can access this page by going to File &gt; New &gt; Connections &gt; Database connection. Open this connection and run the following commands:</p><pre xml:space="preserve"><code class="language-text">drop user lb_dev cascade;
create user lb_dev identified by lb_dev;
grant connect, resource, create view to lb_dev;

drop user lb_test cascade;
create user lb_test identified by lb_test;
grant connect, resource, create view to lb_test;

drop user lb_solo cascade;
create user lb_solo identified by lb_solo;
grant connect, resource, create view to lb_solo;

drop user lb_duplex cascade;
create user lb_duplex identified by lb_duplex;
grant connect, resource, create view to lb_duplex;</code></pre>
        <p>In SQL Developer, create a connection for each of these users. This will be useful later.</p>
        <h2><a>Step 3: Create project directories and standard files</a>
        </h2>
        <p>In this step we will be creating the following directory structure in the <code>trunk</code> directory:</p><pre xml:space="preserve"><code class="language-text">trunk
  +-- install
  |     +-- cst      &lt;-- Contains FK constraints, one file per table
  |     +-- seq      &lt;-- Contains sequence definitions, one file per sequence
  |     +-- tab      &lt;-- Contains table definitions, one file per table
  +-- latest
  |     +-- pkb      &lt;-- Contains package bodies, one file per package
  |     +-- pks      &lt;-- Contains package specifications, one file per package
  |     +-- trg      &lt;-- Contains triggers, one file per trigger
  |     +-- vw       &lt;-- Contains views, one file per view
  +-- v000</code></pre>
        <p>We will create a separate install directory for the installation of non-replaceable objects (as opposed to the upgrades), and within the install directory a separate directory for each type of object.</p>
        <p>Under <code>latest</code>, we have a directory for each type of "replaceable" database object. This means that the object can be updated by simply replacing it by a new version. The SQL syntax for these objects starts with <code>create</code> or <code>replace</code>.</p>
        <p>Paste these commands in a DOS box to create the directory structure in one go:</p><pre xml:space="preserve"><code class="language-text">cd \projects\lbdemo\trunk
mkdir install
mkdir install\cst
mkdir install\seq
mkdir install\tab
mkdir latest
mkdir latest\pkb
mkdir latest\pks
mkdir latest\trg
mkdir latest\vw
mkdir v000</code></pre>
        <p>As we are starting from scratch (version 0), directory <code>v000</code> will contain the <MadCap:variable name="General.changelog" />s to migrate from version 0.</p>
        <p>Create a simple batch file to perform the upgrades:</p>
        <p><b>trunk/lb_update.bat</b>
        </p><pre xml:space="preserve"><code class="language-text">@echo off
call liquibase update --changelog-file=update.xml</code></pre>
        <p>The file above refers to <code>update.xml</code>, which we will create next.</p>
        <p>JDeveloper is a great tool for editing <acronym title="Extensible Markup Language">XML</acronym> files, but creating a new <acronym title="Extensible Markup Language">XML</acronym> file from scratch is a bit cumbersome. The following steps are the quickest way:</p>
        <ul>
            <li>Create an empty file in Windows Explorer (New &gt; TextDocument) and give it the correct filename</li>
            <li>Open this file in JDeveloper</li>
            <li>Copy and paste the file contents from this tutorial into JDeveloper</li>
        </ul>
        <p><b>trunk/update.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
                   &lt;include file="v000/root.xml" /&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Create the file that will later contain the includes of each <MadCap:variable name="General.changelog" /> in order of applicability.</p>
        <p><b>trunk/v000/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 0 --&gt;
        &lt;sqlCheck expectedResult="0"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p class="note" MadCap:autonum="&lt;b&gt;Note: &lt;/b&gt;"><![CDATA[
 ]]><MadCap:variable name="General.Liquibase" /> already checks which changes in a <MadCap:variable name="General.changelog" /> have been run. However, a precondition is still used because if you perform a fresh install of version 5, then the database will not contain the list of changes before version 5. The precondition is an explicit check to ensure that <MadCap:variable name="General.Liquibase" /> doesn't run these changes by accident.</p>
        <p>Commit the current version to Subversion. Right-click on directory trunk and select <b>SVN Commit</b>.</p>
        <p>Enter a message like "Initial version", select all files/directories, and press OK. Now the files/directories will also be displayed with a green icon in Windows explorer.</p>
        <h2><a>Step 4: Create database objects</a>
        </h2>
        <p>Each change (including initial creations) are related to an issue number: a bug or a project task. Our first task (which happens to have number 73) is to create 2 tables.</p>
        <p>The file structure which we will be describing has a certain structure which is easier to see if we visualize it. The white boxes are the directories. The blue boxes are the files within the directories. The arrows indicate that one file calls or includes another file.</p>
        <p style="text-align: center;">
            <img src="../../Z_Resources/Images/Screenshots/workflows/tutorial-files.png" />
        </p>
        <h3><a>Change 73</a>
        </h3>
        <p>The description of this task is:</p>
        <ul>
            <li>Create table <code>departments</code>, the primary key is populated using a sequence and a trigger</li>
            <li>Create table <code>employees</code> with a foreign key to departments</li>
        </ul>
        <p>We will create one changefile for these changes. It will consist of these changes:</p>
        <ul>
            <li>createTable departments</li>
            <li>createSequence</li>
            <li>include of a separate file for the trigger. This file is located in directory <code>latest/trg</code></li>
            <li>createTable employees</li>
        </ul>
        <p>Create the following files:</p>
        <p><b>trunk/v000/2009-10-15-73.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;createTable tableName="departments"
                     remarks="The departments of this company. Does not include geographical divisions."&gt;
            &lt;column name="id" type="number(4,0)"&gt;
                &lt;constraints nullable="false" primaryKey="true"
                             primaryKeyName="DPT_PK"/&gt;
            &lt;/column&gt;
            &lt;column name="dname" type="varchar2(14)"
                    remarks="The official department name as registered on the internal website."/&gt;
        &lt;/createTable&gt;
        &lt;addUniqueConstraint constraintName="departments_uk1"
                             columnNames="dname" tableName="departments"/&gt;
        &lt;createSequence sequenceName="departments_seq"/&gt;
    &lt;/changeSet&gt;    
    &lt;include file="latest/trg/departments_bi.xml"/&gt;    
    &lt;changeSet author="jsmith" id="2"&gt;
        &lt;createTable tableName="employees"&gt;
            &lt;column name="id" type="number(4,0)"&gt;
                &lt;constraints nullable="false" primaryKey="true"
                             primaryKeyName="EMP_PK"/&gt;
            &lt;/column&gt;
            &lt;column name="ename" type="varchar2(14)"
                    remarks="The first and last name"/&gt;
            &lt;column name="salary" type="number(6,2)"
                    remarks="The full remuneration"/&gt;
            &lt;column name="dpt_id" type="number(4,0)"/&gt;
        &lt;/createTable&gt;
        &lt;addForeignKeyConstraint baseColumnNames="dpt_id"
                                 baseTableName="employees"
                                 constraintName="emp_dpt_fk"
                                 referencedColumnNames="id"
                                 referencedTableName="departments"/&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p class="note" MadCap:autonum="&lt;b&gt;Note: &lt;/b&gt;">
The table and column remarks will be applied as table and column comments in the database.</p>
        <p><b>trunk/latest/trg/departments_bi.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1" runOnChange="true"&gt;
        &lt;createProcedure&gt;create trigger departments_bi before insert on departments
for each row
when (new.id is null)
begin
 select departments_seq.nextval into :new.id from dual;
end;
        &lt;/createProcedure&gt;
        &lt;rollback&gt;
            drop trigger departments_bi
        &lt;/rollback&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p class="note" MadCap:autonum="&lt;b&gt;Note: &lt;/b&gt;">
The runOnChange="true" attribute. This ensures that we can make future changes in this file and these changes will be applied automatically. Note also that in the file above, we have provided an explicit rollback statement to undo this change. <MadCap:variable name="General.Liquibase" /> can automatically generate rollback statements for many commands, but not for SQL blocks in which anything may happen.</p>
        <p>Update the <code>root.xml</code> to include the change:</p>
        <p><b>trunk/v000/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 0 --&gt;
        &lt;sqlCheck expectedResult="0"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
    &lt;include file="v000/2009-10-15-73.xml" /&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Now we are ready to test the changes by applying them to the database. Run the batch file we created before:</p><pre xml:space="preserve"><code class="language-text">D:\projects\lbdemo\trunk&gt; lb_update</code></pre>
        <p>If all goes well, you will see a confirmation message: <code>Migration successful</code>.</p>
        <p>Now examine the contents of table <MadCap:variable name="General.databasechangelog" /> using SQL*Developer. You will see 3 rows, corresponding to the 3 <MadCap:variable name="General.changeset" />s we applied. If the change was not exactly what you wanted, you can roll it back. To view the SQL that will roll back the changes:</p><pre xml:space="preserve"><code class="language-text">liquibase rollback-count-sql --count=3 --changelog-file=update.xml</code></pre>
        <p>To actually perform the rollback:</p><pre xml:space="preserve"><code class="language-text">liquibase rollback-count --count=3 --changelog-file=update.xml</code></pre>
        <p>After you have completed and tested your changes, commit them to Subversion with this comment: "73: Create tables departments &amp; employees". The current state is represented by the first box on the diagram at the start of this tutorial.</p>
        <h3><a>Change 59</a>
        </h3>
        <p>This description of this task is:</p>
        <ul>
            <li>Create package <code>departments_pck</code></li>
            <li>Create view <code>departments_vw</code></li>
        </ul>
        <p>Both objects are of the "replaceable" type, so a new version can simply replace an older version. The files go into the <code>latest</code> directory. Create or update the following files:</p>
        <p><b>trunk/v000/root.xml</b> (add the new change to the end of the file)</p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 0 --&gt;
        &lt;sqlCheck expectedResult="0"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
    &lt;include file="v000/2009-10-15-73.xml" /&gt;
    &lt;include file="v000/2009-10-15-59.xml" /&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p><b>trunk/v000/2009-10-15-59.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;include file="latest/pks/departments_pck.xml"/&gt;
    &lt;include file="latest/pkb/departments_pck.xml"/&gt;
    &lt;include file="latest/vw/departments_vw.xml"/&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p><b>trunk/latest/pks/departments_pck.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1" runOnChange="true"&gt;
        &lt;createProcedure&gt;create or replace package departments_pck as
  function  upname(name in varchar2) return varchar2;
end departments_pck;
        &lt;/createProcedure&gt;
        &lt;rollback&gt;
            drop package departments_pck
        &lt;/rollback&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p><b>trunk/latest/pkb/departments_pck.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1" runOnChange="true"&gt;
        &lt;createProcedure&gt;create or replace package body departments_pck as
  function upname(name in varchar2) return varchar2 is
  begin
    return upper(name);
  end;
end departments_pck;
        &lt;/createProcedure&gt;
        &lt;rollback&gt;
            drop package body departments_pck
        &lt;/rollback&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p><b>trunk/latest/vw/departments_vw.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1" runOnChange="true"&gt;
        &lt;createView viewName="departments_vw"&gt;
            select id, dname
            from departments
        &lt;/createView&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Now we are ready to test the changes by applying them to the database. Run the batch file we created before:</p><pre xml:space="preserve"><code class="language-text">D:\projects\lbdemo\trunk&gt; lb_update</code></pre>
        <p>If all goes well, you will see a confirmation message: <code>Migration successful</code>.</p>
        <p>Now examine the contents of table <MadCap:variable name="General.databasechangelog" /> using SQL*Developer. You will see 3 new rows, corresponding to the 3 <MadCap:variable name="General.changeset" />s we applied. Try rolling back the changes, to test the rollback statements we coded:</p><pre xml:space="preserve"><code class="language-text">liquibase rollback-count --count=3 --changelog-file=update.xml</code></pre>
        <p>After you have completed and tested your changes, commit them to Subversion with comment:"59: create departments_pck and departments_vw".</p>
        <p>We could continue in this manner for the remainder of the project. At some point, however, the number of changes may become very large, and we may want to define a new starting point. This is the topic of the next section.</p>
        <h2><a>Step 5: Branch major release</a>
        </h2>
        <p>We are ready to branch for release 1.x. This will allow us to perform a fresh install of version 1.x, without applying the many changes from 0.0 to 1.0. For installations running version 0.x, we also provide the incremental migration possibility.</p>
        <h3><a>Step 5.1: Finalize this version</a>
        </h3>
        <p>The last change to version 0 has been made. After all these changes have been applied, we are effectively at major version 1. The major version is recorded in the<MadCap:variable name="General.databasechangelog" /> table. Modify this file to record this version:</p>
        <p><b>trunk/v000/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!--These changes should only be run against a schema with major version 0--&gt;
        &lt;sqlCheck expectedResult="0"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
    &lt;include file="v000/2009-10-15-73.xml"/&gt;
    &lt;include file="v000/2009-10-15-59.xml"/&gt;    
    &lt;!-- Do not include any more changes in this file --&gt;
    &lt;changeSet author="MajorVersion" id="1" /&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Run the update command to apply the <MadCap:variable name="General.changeset" /> with the version number.</p><pre xml:space="preserve"><code class="language-xml">lb_update</code></pre>
        <h3><a>Step 5.2: Create fresh-install scripts</a>
        </h3>
        <p><![CDATA[
]]><MadCap:variable name="General.Liquibase" /> stores sets of changes in a <MadCap:variable name="General.changelog" />. Although we can create the <MadCap:variable name="General.changelog" /> for the initial objects by hand, it would be nice to be able to generate them from an existing database. The <MadCap:variable name="General.Liquibase" /> <MadCap:xref href="../../commands/inspection/generate-changelog.html">generate-changelog</MadCap:xref> command does export tables to a <MadCap:variable name="General.changelog" /> file, but it has some significant shortcomings:</p>
        <ul>
            <li>Everything is dumped into one file. This does not provide much overview in your version control system.</li>
            <li>It does not export all objects. E.g. triggers and packages are missing.</li>
        </ul>
        <p>So there is room here for a new utility. For now, we will create the installation <MadCap:variable name="General.changelog" />s manually. The organization of the <MadCap:variable name="General.changelog" />s is as follows:</p>
        <ul>
            <li>The "replaceable" objects are stored in the <code>latest</code> directory, as we have seen before.</li>
            <li>Other objects are stored in the <code>install</code> directory.</li>
        </ul>
        <p>Our (manual) utility will create these files:</p>
        <p><b>trunk/install/tab/departments.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;createTable tableName="departments"
                     remarks="The departments of this company. Does not include geographical divisions."&gt;
            &lt;column name="id" type="number(4,0)"&gt;
                &lt;constraints nullable="false" primaryKey="true"
                             primaryKeyName="DPT_PK"/&gt;
            &lt;/column&gt;
            &lt;column name="dname" type="varchar2(14)"
                    remarks="The official department name as registered on the internal website."/&gt;
        &lt;/createTable&gt;
        &lt;addUniqueConstraint constraintName="departments_uk1" columnNames="dname"
                             tableName="departments" /&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p><b>trunk/install/tab/employees.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;createTable tableName="employees"&gt;
            &lt;column name="id" type="number(4,0)"&gt;
                &lt;constraints nullable="false" primaryKey="true"
                             primaryKeyName="EMP_PK"/&gt;
            &lt;/column&gt;
            &lt;column name="ename" type="varchar2(14)"
                    remarks="The first and last name"/&gt;
            &lt;column name="salary" type="number(6,2)"
                    remarks="The full remuneration"/&gt;
            &lt;column name="dpt_id" type="number(4,0)"/&gt;
        &lt;/createTable&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p><b>trunk/install/seq/departments_seq.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;createSequence sequenceName="departments_seq"/&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p><b>trunk/install/cst/employees.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;addForeignKeyConstraint baseColumnNames="dpt_id"
                                 baseTableName="employees"
                                 constraintName="emp_dpt_fk"
                                 referencedColumnNames="id"
                                 referencedTableName="departments"/&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <h3><a>Step 5.3: Reorganize changelog directories and scripts</a>
        </h3>
        <p>Create a new directory for the <MadCap:variable name="General.changelog" />s from 1.0:</p><pre xml:space="preserve"><code class="language-text">mkdir v001</code></pre>
        <p>Create a new <code>root.xml</code> in this directory:</p>
        <p><b>trunk/v001/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 1 --&gt;
        &lt;sqlCheck expectedResult="1"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Edit the update file:</p>
        <p><b>trunk/update.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;include file="v001/root.xml" /&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Create the install script for fresh installs of version 1.x:</p>
        <p><b>trunk/lb_install.bat</b>
        </p><pre xml:space="preserve"><code class="language-text">@echo off
call liquibase update --changelog-file=install.xml
call liquibase update --changelog-file=update.xml</code></pre>
        <p>As you can see above, after the installation of 1.x, we run the updates from 1.x to the latest version.</p>
        <p class="note" MadCap:autonum="&lt;b&gt;Note: &lt;/b&gt;">it would be valid to include the update at the end of the <code>install.xml</code> file as <code>&lt;include file="v001/root.xml" /&gt;</code>. However, for some reason, if we do that then the precondition in <code>root.xml</code> fails.</p>
        <p>Create the <code>install.xml</code>. This file does the fresh install of objects, records the MajorVersion number and includes new changes from version v001 (see last 2 lines in script below):</p>
        <p><b> trunk/install.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;includeAll path="install/tab/" /&gt;
    &lt;includeAll path="install/seq" /&gt;
    &lt;includeAll path="install/cst" /&gt;
    &lt;includeAll path="latest/pks" /&gt;
    &lt;includeAll path="latest/vw" /&gt;
    &lt;includeAll path="latest/pkb" /&gt;
    &lt;includeAll path="latest/trg" /&gt;
    &lt;changeSet author="MajorVersion" id="1" /&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <h3><a>Step 5.4: Test the Fresh Install</a>
        </h3>
        <p>Modify the <MadCap:variable name="General.Liquibase" /> properties file and change the username and password:</p><pre xml:space="preserve"><code class="language-text">username: lb_test
password: lb_test</code></pre>
        <p>Perform the fresh install in schema <code>lb_test</code>:</p><pre xml:space="preserve"><code class="language-text">lb_install</code></pre>
        <p>Modify the <MadCap:variable name="General.Liquibase" /> properties file and change the username and password back to:</p><pre xml:space="preserve"><code class="language-text">username: lb_dev
password: lb_dev</code></pre>
        <p>To verify that the fresh install in lb_test is identical to the incrementally built schema in <code>lb_dev</code> we can use the <MadCap:variable name="General.Liquibase" /> <code>diff</code> command. Enter the following command on the command line:</p><pre xml:space="preserve"><code class="language-text">liquibase diff --url=jdbc:oracle:thin://localhost:9090/mem:test&#160;--username=user1 --password=password --referenceUrl=jdbc:oracle:thin:@localhost:1521/XEPDB1 --referenceUsername=lb_test --referencePassword=lb_test</code></pre>
        <p>This command will give the output in text format and should indicate that there are no differences:</p><pre xml:space="preserve"><code class="language-text">Diff Results:
Base Database: LB_TEST jdbc:oracle:thin:@localhost:1521/XEPDB1
Target Database: LB_DEV jdbc:oracle:thin:@localhost:1521/XEPDB1
Product Name: EQUAL
Product Version: EQUAL
Missing Tables: NONE
Unexpected Tables: NONE
Missing Views: NONE
Unexpected Views: NONE
Missing Columns: NONE
Unexpected Columns: NONE
Changed Columns: NONE
Missing Foreign Keys: NONE
Unexpected Foreign Keys: NONE
Missing Primary Keys: NONE
Unexpected Primary Keys: NONE
Missing Unique Constraints: NONE
Unexpected Unique Constraints: NONE
Missing Indexes: NONE
Unexpected Indexes: NONE
Missing Sequences: NONE
Unexpected Sequences: NONE</code></pre>
        <p><![CDATA[
]]><MadCap:variable name="General.Liquibase" /> can also produce output in <MadCap:variable name="General.changelog" /> format. Look up the <code>diff-changelog</code> command in the manual.</p>
        <p>Release 1.x is technically correct now, ready for branching.</p>
        <p>Commit the current version to Subversion. Right-click on directory trunk and select <b>SVN Commit</b>. Include all the newly created files.</p>
        <p>Enter a message like "Finalize 1.x", select all files, and press OK. Now the files will also be displayed with a green icon in Windows explorer.</p>
        <h3><a>Step 5.5: Branch version 1.x</a>
        </h3>
        <p>Right-click on the <code>trunk</code> and choose <b>TortoiseSVN &gt; Repo-browser</b>. Select <code>trunk</code> in the left pane. By default we are selecting the <code>HEAD</code>, which is correct. But if someone else commited a change on the trunk in the meantime, you would want to select the revision in which you finalized 1.x.</p>
        <p>Right-click on <code>trunk</code> and choose <code>copy to ..</code>.</p>
        <p>Fill in:</p>
        <table>
            <tr>
                <th>New Name:</th>
                <td><code>file:///D:/projects/lbdemo/repo/branches/1.x</code>
                </td>
            </tr>
        </table>
        <p>Enter log message "Branched 1.x" and press OK.</p>
        <p>In the left pan,e under <code>branches</code>, you will now see a folder named 1.x. Right-click on <code>branches/1.x</code> and choose <b>Checkout</b>.</p>
        <table>
            <tr>
                <th>
                    <acronym title="Uniform Resource Locator">URL</acronym> of repository:   </th>
                <td><code>file:///D:/projects/lbdemo/repo/branches/1.x</code><![CDATA[    ]]></td>
            </tr>
            <tr>
                <th>Checkout directory:  </th>
                <td><code>D:\projects\lbdemo\branch_1.x</code> </td>
            </tr>
        </table>
        <p>The new directory will be created, containing the files in this branch. The system test can start, to verify that this version is fit to ship.</p>
        <p>Let's do a fresh install from this directory into the <code>lb_test</code> schema.</p>
        <p>Navigate to directory <code>branch_1.x</code> and copy file <code>liquibase.properties.template</code> to <code>liquibase.properties</code>. Change the connection details to:</p><pre xml:space="preserve"><code class="language-text">username: lb_test
password: lb_test</code></pre>
        <p>Re-create the <code>lb_test</code> schema again using SQLDeveloper. Connect as system and run:</p><pre xml:space="preserve"><code class="language-sql">drop user lb_test cascade;
create user lb_test identified by lb_test;
grant connect, resource, create view to lb_test;</code></pre>
        <p>Perform the fresh install from the directory <code>branch_1.x</code>:</p><pre xml:space="preserve"><code class="language-text">cd \projects\lbdemo\branch_1.x
lb_install</code></pre>
        <h2><a>Step 6: Create test data</a>
        </h2>
        <p>To test data migration functionality, let's insert some test data. In a SQL Developer session, run this script:</p><pre xml:space="preserve"><code class="language-sql">insert into departments (id, dname) values (1, 'HQ');
insert into departments (id, dname) values (2, 'Sales');
insert into employees (id, ename, salary, dpt_id) values (1, 'King', 1200, 1);
insert into employees (id, ename, salary, dpt_id) values (2, 'Smith', 1000, 2);
commit;</code></pre>
        <p>Run this script in the <b>lb_dev</b> schema and in the <b>lb_test</b> schema. We won't create <MadCap:variable name="General.Liquibase" /> scripts for this data, and we won't store the scripts in Subversion. If you want to learn more about maintaining setup data and test data, look up the <b>insert data</b> and <b>load data</b> functionality in the <MadCap:variable name="General.Liquibase" /> manual.</p>
        <h2><a>Step 7: Fix bug 102</a>
        </h2>
        <p>The system test on version 1.x has revealed a bug and it needs to be fixed before we can ship version 1.0. We fix bugs on the trunk, and then backport them to the relevant branches.</p>
        <p>This change has been registered in our issue tracker with number 102. The change description is:</p>
        <ul>
            <li>replace column <code>employees.salary</code> by two new columns: <code>fixed_salary</code> and <code>bonus</code> (both <code>NOT-NULL</code>)</li>
            <li>The value of <code>bonus</code> should be <code>salary *0.1</code><![CDATA[           ]]></li>
            <li>The value of <code>fixed_salary</code> should be <code>salary * 0.9</code><![CDATA[           ]]></li>
        </ul>
        <p>Remember that our changes are now taking us from version 1.x, so the <MadCap:variable name="General.changelog" />s go in directory <code>v001</code>. Create the following <MadCap:variable name="General.changelog" />:</p>
        <p><b> trunk/v001/2009-10-16-102.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;addColumn tableName="employees"&gt;
            &lt;column name="fixed_salary" type="number(6,2)"
                    remarks="Monthly gross salary"/&gt;
            &lt;column name="bonus" type="number(6,2)"
                    remarks="On-target monthly bonus"/&gt;
        &lt;/addColumn&gt;
        &lt;update tableName="employees"&gt;
            &lt;column name="fixed_salary" valueNumeric="salary * 0.9"/&gt;
            &lt;column name="bonus" valueNumeric="salary * 0.1"/&gt;
        &lt;/update&gt;
        &lt;addNotNullConstraint tableName="employees" columnName="fixed_salary" /&gt;
        &lt;addNotNullConstraint tableName="employees" columnName="bonus" /&gt;
        &lt;dropColumn tableName="employees" columnName="salary" /&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Update <code>root.xml</code> to include this file:</p>
        <p><b>trunk/v001/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 1 --&gt;
        &lt;sqlCheck expectedResult="1"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
    &lt;include file="v001/2009-10-16-102.xml"/&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Run the update command:</p><pre xml:space="preserve"><code class="language-text">lb_update</code></pre>
        <p class="note" MadCap:autonum="&lt;b&gt;Note: &lt;/b&gt;">This change cannot be rolled back automatically. If we wanted to be able to roll this back, we would have had to specify the rollback logic.</p>
        <p>Use SQL Developer to check that the changes have successfully been applied.</p><pre xml:space="preserve"><code class="language-sql">DESC employees

Name                 Null     Type
-------------------- -------- ------------
ID                   NOT NULL NUMBER(4)
ENAME                         VARCHAR2(14)
DPT_ID                        NUMBER(4)
FIXED_SALARY         NOT NULL NUMBER(6,2)
BONUS                NOT NULL NUMBER(6,2)

5 rows selected

SELECT * FROM employees;

ID   ENAME     DPT_ID    FIXED_SALARY   BONUS
---- --------- --------- -------------- -----
1    King      1         1080           120  
2    Smith     2         900            100  

2 rows selected</code></pre>
        <p>Commit these changes using TortoiseSVN. Enter log message: "102: Replace salary by fixed_salary and bonus".</p>
        <h2><a>Step 8: Backport bug 102 to branch 1.x</a>
        </h2>
        <h4><a>Perform the merge</a>
        </h4>
        <p>Right-click on directory <code>branch_1.x</code> and choose <b>TortoiseSVN &gt; Merge</b>.</p>
        <table>
            <tr>
                <th>Merge type:</th>
                <td> Merge a range of revisions</td>
            </tr>
        </table>
        <p>Press Next.</p>
        <table>
            <tr>
                <th>
                    <acronym title="Uniform Resource Locator">URL</acronym> to merge from:</th>
                <td><code> file:///D:/projects/lbdemo/repo/trunk</code>
                </td>
            </tr>
            <tr>
                <th>Revision range to merge:</th>
                <td> Use the <code>[Show log]</code> button to display the list of revisions. Select the change for bug 102.</td>
            </tr>
        </table>
        <p>Press Next, then Merge, and then press OK to close the results window.</p>
        <p>In Windows Explorer, you will see that <code>2009-10-16-102.xml</code> has been added to the <code>v001</code> directory, and that <code>v001/root.xml</code> has been updated. Right-click on file <code>root.xml</code> and choose <b>TortoiseSVN &gt; Diff</b>. You will see that only the one line has been added to <code>root.xml</code>.</p>
        <p>Commit <code>branch_1.x</code> with comment "102: backport".</p>
        <h4><a>Test the results</a>
        </h4>
        <p>Run the update command:</p><pre xml:space="preserve"><code class="language-text">cd D:\projects\lbdemo\branch_1.x
lb_update</code></pre>
        <p>Use SQL Developer to confirm that the employees in schema lb_test now have a fixed salary and a bonus.</p>
        <h4><a>Tag this revision as 1.0</a>
        </h4>
        <p>The acceptance test has now been completed, so we can label this version as our "1.0" release. Right-click on <code>branch_1.x</code> and choose <b>TortoiseSVN &gt; Branch/Tag</b>. Fill out the dialogue as shown below:</p>
        <table>
            <tr>
                <th>From WC at <acronym title="Uniform Resource Locator">URL</acronym>:</th>
                <td><code>file:///D:/projects/lbdemo/repo/branches/1.x</code>
                </td>
            </tr>
            <tr>
                <th>To <acronym title="Uniform Resource Locator">URL</acronym>:</th>
                <td><code>file:///D:/projects/lbdemo/repo/tags/1.0</code>
                </td>
            </tr>
            <tr>
                <th>Create copy in the repository from:</th>
                <td>(leave as default)</td>
            </tr>
            <tr>
                <th>Log message:</th>
                <td>Tagged as 1.0</td>
            </tr>
        </table>
        <p>Press OK and close the repository browser. We can now deliver version 1.0 to the customer.</p>
        <h2><a>Step 9: Install 1.0 for Solo</a>
        </h2>
        <p>We can now deliver version 1.0 to our customer Solo. Create directory <code>D:\projects\lbdemo\solo</code>. Right-click on this directory and choose TortoiseSVN &gt; Export. Fill out the dialogue as shown below:</p>
        <table>
            <tr>
                <th>
                    <acronym title="Uniform Resource Locator">URL</acronym> of repository:</th>
                <td><code>file:///D:/projects/lbdemo/repo/tags/1.0</code>
                </td>
            </tr>
            <tr>
                <th>Export directory:</th>
                <td><code>D:\projects\lbdemo\solo</code>
                </td>
            </tr>
        </table>
        <p>Leave the rest as default and press OK. The files will be exported to the solo directory.</p>
        <p>Copy the file <code>liquibase.properties.template</code> to <code>liquibase.properties</code> and change the username and password to <code>lb_solo</code>.</p>
        <p>Apply the <MadCap:variable name="General.changelog" /> for the initial installation and the patches of version 1.0 to the empty schema of Solo:</p><pre xml:space="preserve"><code class="language-text">cd D:\projects\lbdemo\solo
lb_install</code></pre>
        <p>Twice, you should receive the confirmation "Migration successful", and Solo is running on 1.0.</p>
        <h2><a>Step 10: Further development on the trunk (change 105)</a>
        </h2>
        <p>The specifications for this change are:</p>
        <ul>
            <li>add <code>column mgr_id</code> to the departments table, to be populated by the <code>mgr_id</code> of King.</li>
            <li>add a foreign key: <code>departments.mgr_id</code> -&gt; <code>employees.id</code><![CDATA[            ]]></li>
        </ul>
        <p>Create the <MadCap:variable name="General.changelog" />:</p>
        <p><b>trunk/v001/2009-10-16-105.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;addColumn tableName="departments"&gt;
            &lt;column name="mgr_id" type="number(4,0)"/&gt;
        &lt;/addColumn&gt;
        &lt;sql&gt;update departments
             set mgr_id = (select id
                           from employees
                           where ename='King');
        &lt;/sql&gt;
        &lt;addForeignKeyConstraint baseColumnNames="mgr_id"
                                 baseTableName="departments"
                                 constraintName="dpt_emp_fk1"
                                 referencedColumnNames="id"
                                 referencedTableName="employees"/&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Update <code>root.xml</code> to include this file:</p>
        <p><b>trunk/v001/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 1 --&gt;
        &lt;sqlCheck expectedResult="1"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
    &lt;include file="v001/2009-10-16-102.xml"/&gt;
    &lt;include file="v001/2009-10-16-105.xml"/&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Run the update command:</p><pre xml:space="preserve"><code class="language-text">lb_update</code></pre>
        <p>Use SQL Developer to check that the changes have been applied correctly.</p>
        <p>Commit these changes using TortoiseSVN, with comment "105: Add <code>mgr_id</code> and foreign key".</p>
        <h2><a>Step 11: Branch major release 2.x</a>
        </h2>
        <p>This is the same as step 5. Repeat step 5, replacing 1.x by 2.x.</p>
        <p>However, there is a difference. Customers running 1.x need to be able to upgrade to 2.x. We did not cover that aspect previously. If a 1.x customer were simply to run <code>lb_update</code>, then it would fail on the precondition in the <code>root.xml</code>:</p><pre xml:space="preserve"><code class="language-xml">&lt;preConditions&gt;
    &lt;!-- These changes should only be run against a schema with major version 2 --&gt;
    &lt;sqlCheck expectedResult="2"&gt;
        SELECT NVL(MAX(id),0)
        FROM databasechangelog
        WHERE author='MajorVersion'
    &lt;/sqlCheck&gt;
&lt;/preConditions&gt;</code></pre>
        <p>So how do we ensure that all the changes between "finalize 1.x" and "finalize 2.x" have been applied before applying the 2.x changes? If you look at the diagram at the beginning of this tutorial, you will see that we are talking about change 105. Change 105 was never delivered in the 1.x branch and it is not contained in the <code>v002/root.xml</code>.</p>
        <p>The answer is that we create two new files as part of step 5.3:</p>
        <p><b>trunk/lb_upgrade_to_major.bat</b>
        </p><pre xml:space="preserve"><code class="language-xml">@echo off
call liquibase update --changelog-file=upgrade_to_major.xml
call liquibase update --changelog-file=update.xml</code></pre>
        <p><b>trunk/upgrade_to_major.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;include file="v001/root.xml" /&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <h2><a>Step 12: Change 114, rename column</a>
        </h2>
        <p>Testing on branch 2.x revealed a bug that we want fixed on branch 1.x as well. Column <code>employees.ename</code> needs to be renamed to <code>full_name</code>. Refer to the diagram at the start of this tutorial for a visual overview of this step.</p>
        <p>Create the <MadCap:variable name="General.changelog" />:</p>
        <p><b>trunk/v002/2009-10-18-114.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;changeSet author="jsmith" id="1"&gt;
        &lt;renameColumn newColumnName="full_name" oldColumnName="ename" tableName="employees"/&gt;
    &lt;/changeSet&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Update <code>root.xml</code> to include this file:</p>
        <p><b>trunk/v002/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 2 --&gt;
        &lt;sqlCheck expectedResult="2"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
    &lt;include file="v002/2009-10-18-114.xml"/&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <p>Run the update command:</p><pre xml:space="preserve"><code class="language-text">lb_update</code></pre>
        <p>Use SQL Developer to check that the changes have been applied correctly.</p>
        <p>Commit these changes using TortoiseSVN, with comment "114: Renamed employee.ename to full_name".</p>
        <h2><a>Step 13: Backport change 114 to branch 1.x</a>
        </h2>
        <p>This is the same as step 8 with a major exception. On the trunk, change 114 is recorded in directory <code>v002</code> and in file <code>v002/root.xml</code>.</p>
        <p>Branch 1.x does not have a directory <code>v002</code>. We will create this directory to contain the <MadCap:variable name="General.changelog" />. However, note that we will <b>not</b> create a file named <code>v002/root.xml</code>. There should only be one <code>root.xml</code> on a branch, as it contains the order of the changes.</p>
        <p>Change 114 will be referenced in <code>v001/root.xml</code> as follows:</p>
        <p><b>branch_1.x/v001/root.xml</b>
        </p><pre xml:space="preserve"><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
<MadCap:snippetText src="../../Z_Resources/Snippets/code/liquibase-xsd-xml-changelog-closed.flsnp" />
    &lt;preConditions&gt;
        &lt;!-- These changes should only be run against a schema with major version 1 --&gt;
        &lt;sqlCheck expectedResult="1"&gt;
            SELECT NVL(MAX(id),0)
            FROM databasechangelog
            WHERE author='MajorVersion'
        &lt;/sqlCheck&gt;
    &lt;/preConditions&gt;
    &lt;include file="v001/2009-10-16-102.xml"/&gt;
    &lt;include file="v002/2009-10-18-114.xml"/&gt;
&lt;/databaseChangeLog&gt;</code></pre>
        <h2><a>Step 14: Backport change 114 to branch 2.x</a>
        </h2>
        <p>This is the same as step 8.</p>
        <h2><a>Step 15: Deliver release 1.1 to Solo</a>
        </h2>
        <p>This is the same as step 9, except you will run the <code>lb_update</code> command instead of <code>lb_install</code> to update Solo to the latest version of the 1.x branch.</p>
        <h2><a>Step 16: Deliver 2.0 as a fresh install to customer Duplex</a>
        </h2>
        <p>This is also the same as step 9, but taking the export from tag 2.0.</p>
        <h2><a>Step 17: Deliver 2.0 as an upgrade to customer Solo</a>
        </h2>
        <p>The same export created in the previous step can be delivered to customer Solo.</p>
        <p>Customer lb_solo runs the <code>lb_upgrade_to_magor</code> command.</p>
        <h2><a>Summary of developer procedures</a>
        </h2>
        <h3><a>Database refactorings</a>
        </h3>
        <p>The default action is to create a change file named <code>&lt;date&gt;-IssueNr&gt;.xml</code> in directory <code>vXXX</code> and specify the change in this file. Example filename: <code>v002/2009-12-25-305.xml</code></p>
        <table>
            <thead>
                <tr>
                    <th>&#160;</th>
                    <th>Create</th>
                    <th>Modify</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Table</th>
                    <td>Default</td>
                    <td>Default</td>
                    <td>Default</td>
                </tr>
                <tr>
                    <th>Sequence</th>
                    <td>Default</td>
                    <td>Default</td>
                    <td>Default</td>
                </tr>
                <tr>
                    <th>View</th>
                    <td>Create new file in directory <code>latest/vw</code>. Include this file in the change file.</td>
                    <td>Modify file in directory <code>latest/vw</code>. Include this file in the change file.</td>
                    <td>See below</td>
                </tr>
                <tr>
                    <th>Trigger</th>
                    <td>Create new file in directory <code>latest/trg</code>. Include this file in the change file.</td>
                    <td>Modify file in directory <code>latest/trg</code>. Include this file in the change file.</td>
                    <td>See below</td>
                </tr>
                <tr>
                    <th>Package</th>
                    <td>Create new file in directory <code>latest/pck</code>. Include this file in the change file.</td>
                    <td>Modify file in directory <code>latest/pck</code>. Include this file in the change file.</td>
                    <td>See below</td>
                </tr>
            </tbody>
        </table>
        <h4><a>Delete object from latest directory (view, trigger, package)</a>
        </h4>
        <p>The procedure is described here for a view, and is similar for triggers and packages.</p>
        <p>Delete the view from the <code>latest/vw</code> directory.</p>
        <p>Create a changeset to delete the view, with a preCondition. The preCondition prevents an error condition if the view does not exist. This will be the case if we run a <MadCap:variable name="General.changelog" /> on a database before the definition of the view:</p><pre xml:space="preserve"><code class="language-xml">&lt;changeSet author="jsmith" id="1"&gt;
    &lt;preConditions onFail="MARK_RAN"&gt;
        &lt;viewExists viewName="departments_vw"&gt;
    &lt;/preConditions&gt;
    &lt;dropView viewName="departments_vw"/&gt;
&lt;/changeSet&gt;</code></pre>
        <p>Or an alternative:</p><pre xml:space="preserve"><code class="language-xml">&lt;changeSet author="jsmith" id="1" failOnError="false"&gt;
    &lt;dropView viewName="departments_vw"/&gt;
&lt;/changeSet&gt;</code></pre>
        <p>Add the changeset to the master.</p>
        <p>Search all <MadCap:variable name="General.changelog" />s for inclusion of the view definition (which no longer exists). Remove this line from the relevant <MadCap:variable name="General.changelog" />s.</p>
        <h3><a>Other Procedures (non-refactoring)</a>
        </h3>
        <h4><a>Branch major release</a>
        </h4>
        <p>As an example, let's assume that you are ready to branch for release 4.x.</p>
        <p>The trunk will contain:</p>
        <ul>
            <li>The installation scripts for 3.x</li>
            <li>The upgrade <MadCap:variable name="General.changelog" />s to upgrade from 2.x (to 3.x)</li>
            <li>The upgrade <MadCap:variable name="General.changelog" />s to upgrade from 3.x (to 4.x)</li>
        </ul>
        <p>On the trunk, perform the following actions:</p>
        <ol>
            <li>Create fresh install scripts for 4.x (replacing those for 3.x)</li>
            <li>Delete all (upgrade) <MadCap:variable name="General.changelog" />s from 2.x</li>
            <li>Create an empty <MadCap:variable name="General.changelog" /> container for 4.x</li>
            <li>Replace names of these containers in <code>root.xml</code></li>
            <li>Commit</li>
        </ol>
        <p>Create a branch from this revision with name "4.x". The x indicates that all further patches on 4.0 will take place on this branch. Development of 4.1 will take place on the trunk.</p>
    </body>
</html>