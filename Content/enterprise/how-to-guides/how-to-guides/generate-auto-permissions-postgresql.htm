<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
	<head>
		<title>Liquibase Enterprise Documentation</title>
		<meta name="description" content="Liquibase Enterprise Documentation" />
	</head>
	<body>
		<h1>How To: Generate Auto Permissions for PostgreSQL</h1>
		<MadCap:snippetText src="../../../Resources/Snippets/images/.ver_icon_size_enterprise.flsnp" />
		<h1 id="HowTo:GenerateAutoPermissionsforPostgreSQL-Overview">Overview</h1>
		<MadCap:snippetText src="../../../Resources/Snippets/images/.ver_icon_size_enterprise.flsnp" />
		<p>There are situations where grants may need to be created for all objects that meet a particular criteria such as belonging to a specific schema. This can be accomplished by creating a changeset that is executed at the end of every deployment to apply the appropriate grants.</p>
		<h3 id="HowTo:GenerateAutoPermissionsforPostgreSQL-Step1–CreateaScripttoPerformGrantOperations">Step 1 – Create a Script to Perform Grant Operations</h3>
		<p>Create a script that will generate the desired grant or alias statements. The script can utilize change log properties (<a href="set-prop-project-changelog.htm">Setting Properties in the Project Changelog</a> ) to customize values for different steps in the pipeline. The following is an example of a script to grant privileges to an Application User for all tables in a specified schema. The criteria for APPUSER will be specified by properties from the project changelog.</p>
		<p>
			Save the script to a location outside the SQL SCM for the 
			<MadCap:variable name="General.DaticalDB" />
			Project since we will manually add the changeset to the changelog.
		</p>
		<pre class="syntaxhighlighter-pre" xml:space="preserve">DO $$
declare
t record;
BEGIN
    FOR t IN
        SELECT table_schema, table_name from information_schema.tables where table_schema not in ('pg_catalog','information_schema')
    LOOP
        execute format('GRANT INSERT, SELECT, UPDATE, DELETE ON TABLE %I.%I TO ${APPUSER}', t.table_schema, t.table_name);
    END LOOP;
end;
$$;</pre>
		<h3 id="HowTo:GenerateAutoPermissionsforPostgreSQL-Step2–CreateChangelogPropertiesforReplacementVariables">Step 2 – Create Changelog Properties for Replacement Variables</h3>
		<p>
			If the script requires different values based upon context or labels, create the required properties. Go the Project Settings in the 
			<MadCap:variable name="General.DaticalDB" />
			GUI and select Manage Properties.
		</p>
		<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" width="115" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/ChangeLogProperties.png?version=1&amp;modificationDate=1585867618974&amp;cacheVersion=1&amp;api=v2&amp;width=115&amp;height=90" srcset="https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/ChangeLogProperties.png?version=1&amp;modificationDate=1585867618974&amp;cacheVersion=1&amp;api=v2&amp;width=230&amp;height=180 2x, https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/ChangeLogProperties.png?version=1&amp;modificationDate=1585867618974&amp;cacheVersion=1&amp;api=v2&amp;width=115&amp;height=90 1x" /></span>
		<p>Add the properties to be used by the script along with the Context or Label where the property value should be applied. Within the script specify the Property Key using the syntax ${property_key}.</p>
		<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1166934452/image-20200402-224922.png?version=1&amp;modificationDate=1585867657885&amp;cacheVersion=1&amp;api=v2" /></span>
		<h3 id="HowTo:GenerateAutoPermissionsforPostgreSQL-Step3–AddtheChangeSettotheChangeLog">Step 3 – Add the ChangeSet to the ChangeLog</h3>
		<p>
			From the 
			<MadCap:variable name="General.DaticalDB" />
			GUI, Select "Add a Change Set".
		</p>
		<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" width="54" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/AddAChangeSet.png?version=1&amp;modificationDate=1585867748181&amp;cacheVersion=1&amp;api=v2&amp;width=54&amp;height=104" srcset="https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/AddAChangeSet.png?version=1&amp;modificationDate=1585867748181&amp;cacheVersion=1&amp;api=v2&amp;width=108&amp;height=208 2x, https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/AddAChangeSet.png?version=1&amp;modificationDate=1585867748181&amp;cacheVersion=1&amp;api=v2&amp;width=54&amp;height=104 1x" /></span>
		<p>Scroll down and select the "Execute a SQL script file using JDBC"/"Custom SQL (External File)" change type. Note that "Execute a SQL script file using JDBC" is the newer name, and "Custom SQL (External File)" is the older name for the same change type.</p>
		<span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" width="115" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/ExternalFile.png?version=1&amp;modificationDate=1585867762217&amp;cacheVersion=1&amp;api=v2&amp;width=115&amp;height=64" srcset="https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/ExternalFile.png?version=1&amp;modificationDate=1585867762217&amp;cacheVersion=1&amp;api=v2&amp;width=230&amp;height=128 2x, https://datical-cs.atlassian.net/wiki/download/thumbnails/1166934452/ExternalFile.png?version=1&amp;modificationDate=1585867762217&amp;cacheVersion=1&amp;api=v2&amp;width=115&amp;height=64 1x" /></span>
		<p>Browse to select the file. Deselect Split Statements.</p>
		<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1166934452/auto_table_grants.PNG?version=1&amp;modificationDate=1585867916654&amp;cacheVersion=1&amp;api=v2" /></span>
		<p>On the next screen select Finalize.</p>
		<p>On the Create Change Set screen:</p>
		<p>Enter the ChangeSet ID (any text string) and the Author.</p>
		<p>Set the Execution Settings to:</p>
		<p>"Redeploy this Change Set every time the contents are modified" – Allows modification of the SQL file saved to the resources directory. Without this there will be "checksum" errors if the file is modified.</p>
		<p> "Deploy this Change Set every time a deployment is performed" – Changeset will be run for every Deployment.</p>
		<p>Set Deploy Order to "After Other Change Sets".</p>
		<span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1166934452/AuthorId.png?version=1&amp;modificationDate=1585867982175&amp;cacheVersion=1&amp;api=v2" /></span>
		<p>Save changes by selecting: File &gt;&gt; Save.</p>
		<p>Add, Commit, and Push the changes to the SCM.</p>
		<h3 id="HowTo:GenerateAutoPermissionsforPostgreSQL-Step5–TesttheNewChangeSet">Step 5 – Test the New Change Set</h3>
		<p>Package and deploy a simple "CREATE TABLE" script. Verify that the grants are applied to the new table.</p>
	</body>
</html>