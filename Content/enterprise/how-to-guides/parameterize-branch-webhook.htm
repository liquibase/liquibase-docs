<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head><title><MadCap:variable name="Heading.Level1" /></title>
        <meta name="description" content="Liquibase Enterprise Documentation" />
    </head>
    <body>
        <h1>How To: Parameterize Branch Name for Webhook</h1>
        <MadCap:snippetText src="../../Z_Resources/Snippets/images/icon-enterprise-top.flsnp" />
        <p>Some of our customers wish to pass Branch Name as a Jenkins input parameter for the Packager job so that a specific <MadCap:variable name="General.DaticalDB" /> Pipeline can be targeted. The below steps outline how this can be performed using the Generic Webhook Trigger Plugin.</p>
        <h2 id="HowTo:ParameterizeBranchNameforWebhook-GenericWebhookTriggerPluggin">Generic Webhook Trigger Pluggin</h2>
        <ul>
            <li>
                <p><a class="external-link" href="https://plugins.jenkins.io/generic-webhook-trigger/" rel="nofollow">https://plugins.jenkins.io/generic-webhook-trigger/</a>
                </p>
            </li>
        </ul>
        <p>This plugin allows Jenkins access to the HTTP payload that triggered the build. Values, such as Branch name, can be extracted from the payload and used as filters and passed to Jenkins input parameters.</p>
        <h2 id="HowTo:ParameterizeBranchNameforWebhook-GitHubInstructions">GitHub Instructions</h2>
        <ol>
            <li>
                <p>In Jenkins, install the Generic Webhook Trigger Pluggin using Manage Jenkins → Manage Plugins</p>
            </li>
            <li>
                <p>After installing the plugin you will see a checkbox under Build Triggers for Generic Webhook Trigger. Check the box to access the configurations.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" width="646" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/image-20200422-144531.png?version=1&amp;modificationDate=1587566621423&amp;cacheVersion=1&amp;api=v2&amp;width=646&amp;height=164" srcset="https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/image-20200422-144531.png?version=1&amp;modificationDate=1587566621423&amp;cacheVersion=1&amp;api=v2&amp;width=1292&amp;height=328 2x, https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/image-20200422-144531.png?version=1&amp;modificationDate=1587566621423&amp;cacheVersion=1&amp;api=v2&amp;width=646&amp;height=164 1x" /></span>
            </li>
            <li>
                <p>In the Post content parameters add a variable, eg. ref. You will need to provide a JSONPath or XPath expression to extract the value from the HTTP payload.</p>
                <ol>
                    <li>
                        <p>Sample HTTP payload from my Github webhook can be found here - <a href="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/SampleHttpPayload.json?api=v2" rel="nofollow">SampleHttpPayload.json</a></p>
                    </li>
                    <li>
                        <p>JSONPath evaluator can be found here - <a class="external-link" href="https://jsonpath.com/" rel="nofollow">https://jsonpath.com/</a></p>
                    </li>
                    <li>
                        <p>In this example we have two variables:</p>
                        <ul>
                            <li>
                                <p><strong>ref</strong> - value will be used to extract branch name from the SQL Repo triggering the webhook. JSONPath Expression: $.ref</p>
                            </li>
                            <li>
                                <p><strong>author</strong> - value will be used to extract the author of the change. We need to exclude Jenkins user from triggering builds when Datical does the check-in at end of Packager process. JSONPath Expression: $.head_commit.author.name</p>
                            </li>
                            <li><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-145629.png?version=1&amp;modificationDate=1587567279430&amp;cacheVersion=1&amp;api=v2" /></span>
                            </li>
                        </ul>
                    </li>
                </ol>
            </li>
            <li>
                <p>You will want to add a token. This token will be used when setting up the Webhook.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-145830.png?version=1&amp;modificationDate=1587567400862&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
            <li>
                <p>For debug/troubleshooting purposes Print post content and Print contributed variables. These settings will print the content of your HTTP payload and any variables you have specified above. You can turn them off later once everything is working.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-150011.png?version=1&amp;modificationDate=1587567501132&amp;cacheVersion=1&amp;api=v2" /></span>
                <p>This logging will appear as below in the Jenkins console log:</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" width="646" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/InkedConsoleLog_LI.jpg?version=1&amp;modificationDate=1587574537803&amp;cacheVersion=1&amp;api=v2&amp;width=646&amp;height=128" srcset="https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/InkedConsoleLog_LI.jpg?version=1&amp;modificationDate=1587574537803&amp;cacheVersion=1&amp;api=v2&amp;width=1292&amp;height=256 2x, https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/InkedConsoleLog_LI.jpg?version=1&amp;modificationDate=1587574537803&amp;cacheVersion=1&amp;api=v2&amp;width=646&amp;height=128 1x" /></span>
                <p>And</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-150841.png?version=1&amp;modificationDate=1587568010547&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
            <li>
                <p>Optional filter</p>
                <ol>
                    <li>
                        <p>Here is where you specify filters for the webhook. You can string together multiple filters. In this case we only want to trigger builds for the branch/pipelines named current and data_corrections. We do not want to trigger a build for master or any other branch name.</p>
                    </li>
                    <li>
                        <p>Additionally we want to prevent builds from triggering when the check-in is performed by the Jenkins user named Admin.</p>
                    </li>
                    <li>
                        <p>Expression:</p><pre class="syntaxhighlighter-pre" xml:space="preserve">^(?!.*Admin).*(refs\/heads\/current|refs\/heads\/data_corrections).*$</pre>
                    </li>
                    <li>
                        <p>Text: $ref $author</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-150504.png?version=1&amp;modificationDate=1587567794586&amp;cacheVersion=1&amp;api=v2" /></span>
                    </li>
                </ol>
            </li>
            <li>
                <p>For the job's Branch Input Parameter (here called ref) you can reference the parameters set in the Post content parameters section described above. Please note that Branch will need to be extracted from the ref value because ref is in the payload as eg. refs/heads/master or refs/heads/data_corrections.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-151135.png?version=1&amp;modificationDate=1587568185257&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
            <li>
                <p>In the Jenkinsfile to extract the Branch from the ref input value, add the following to the environment section:</p><pre class="syntaxhighlighter-pre" xml:space="preserve">BRANCH="${params.ref}".substring("${params.ref}".lastIndexOf("/") + 1)
				PIPELINE="${BRANCH}"</pre>
            </li>
            <li>
                <p>Finally you will need to add your trigger to the GitHub SQL repository. Go to the specific SQL Repository → Settings → Webhooks → Add webhook</p>
                <ol>
                    <li>
                        <p>Payload URL will be eg. <a class="external-link" href="http://dunder-mifflin.datical.net:8080/generic-webhook-trigger/invoke?token=abc" rel="nofollow">http://dunder-mifflin.datical.net:8080/generic-webhook-trigger/invoke?token=abc</a></p>
                    </li>
                    <li>
                        <p>Content type: application/json</p>
                    </li>
                    <li>
                        <p>Configure which events you would like to trigger the webhook</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/Inkedimage-20200422-151704_LI.jpg?version=2&amp;modificationDate=1587574076399&amp;cacheVersion=1&amp;api=v2" /></span>
                        <p><em><strong>Note:</strong> if you have an error here for whatever reason, eg. there are no Jobs in Jenkins that match the parameters when setting up the webhook, GitHub seems to mark the webhook as in error. Updating an existing webhook marked in error does not "fix" the webhook. It will need to be deleted and a new webhook must be created.</em>
                        </p>
                    </li>
                </ol>
            </li>
            <li>
                <p>Test your webhook setup by making a change to the desired branch and check if the webhook shows a Successful Delivery and Jenkins Build is started as expected:</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-152411.png?version=2&amp;modificationDate=1587574026663&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
        </ol>
        <h2 id="HowTo:ParameterizeBranchNameforWebhook-BitBucketInstructions">BitBucket Instructions</h2>
        <ol>
            <li>
                <p>In Jenkins, install the Generic Webhook Trigger Pluggin using Manage Jenkins → Manage Plugins</p>
            </li>
            <li>
                <p>After installing the plugin you will see a checkbox under Build Triggers for Generic Webhook Trigger. Check the box to access the configurations.</p><span class="confluence-embedded-file-wrapper image-center-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image image-center" width="646" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/image-20200422-144531.png?version=1&amp;modificationDate=1587566621423&amp;cacheVersion=1&amp;api=v2&amp;width=646&amp;height=164" srcset="https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/image-20200422-144531.png?version=1&amp;modificationDate=1587566621423&amp;cacheVersion=1&amp;api=v2&amp;width=1292&amp;height=328 2x, https://datical-cs.atlassian.net/wiki/download/thumbnails/1223491670/image-20200422-144531.png?version=1&amp;modificationDate=1587566621423&amp;cacheVersion=1&amp;api=v2&amp;width=646&amp;height=164 1x" /></span>
            </li>
            <li>
                <p>In the Post content parameters add a variable, eg. BRANCH. You will need to provide a JSONPath or XPath expression to extract the value from the HTTP payload.</p>
                <ol>
                    <li>
                        <p>Sample HTTP payload from my Bitbucket webhook can be found here - <a href="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/JsonPayloadBitbucket.json?api=v2" rel="nofollow">SampleHttpPayloadBitbucket.json</a></p>
                    </li>
                    <li>
                        <p>JSONPath evaluator can be found here - <a class="external-link" href="https://jsonpath.com/" rel="nofollow">https://jsonpath.com/</a></p>
                    </li>
                    <li>
                        <p>In this example we have two variables:</p>
                        <ul>
                            <li>
                                <p><strong>BRANCH</strong> - value will be used to extract branch name from the SQL Repo triggering the webhook. JSONPath Expression: $.changes..refId</p>
                            </li>
                            <li>
                                <p><strong>author</strong> - value will be used to extract the author of the change. We need to exclude Jenkins user from triggering builds when Datical does the check-in at end of Packager process. JSONPath Expression: $.actor.displayName</p>
                            </li>
                            <li><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/BitbucketRef.PNG?version=2&amp;modificationDate=1601996294208&amp;cacheVersion=1&amp;api=v2" /></span>
                            </li>
                        </ul>
                    </li>
                </ol>
            </li>
            <li>
                <p>You will want to add a token. This token will be used when setting up the Webhook.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-145830.png?version=1&amp;modificationDate=1587567400862&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
            <li>
                <p>For debug/troubleshooting purposes Print post content and Print contributed variables. These settings will print the content of your HTTP payload and any variables you have specified above. You can turn them off later once everything is working.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/image-20200422-150011.png?version=1&amp;modificationDate=1587567501132&amp;cacheVersion=1&amp;api=v2" /></span>
                <p>This logging will appear as below in the Jenkins console log:</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/InkedConsoleOutput_LI.jpg?version=1&amp;modificationDate=1601996330016&amp;cacheVersion=1&amp;api=v2" /></span>
                <p>And</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/Variables-Bitbucket.PNG?version=1&amp;modificationDate=1601996352033&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
            <li>
                <p>Optional filter</p>
                <ol>
                    <li>
                        <p>Here is where you specify filters for the webhook. You can string together multiple filters. In this case we only want to trigger builds for the branch/pipelines named deploy-test1. We do not want to trigger a build for master or any other branch name.</p>
                    </li>
                    <li>
                        <p>Additionally we want to prevent builds from triggering when the check-in is performed by the Jenkins user named Jenkins.</p>
                    </li>
                    <li>
                        <p>Expression:</p><pre class="syntaxhighlighter-pre" xml:space="preserve">^(?!.*jenkins).*(refs\/heads\/deploy-test1).*$</pre>
                    </li>
                    <li>
                        <p>Text: $ref $author</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/OptionalFilter.PNG?version=1&amp;modificationDate=1601996372546&amp;cacheVersion=1&amp;api=v2" /></span>
                    </li>
                </ol>
            </li>
            <li>
                <p>For the job's Branch Input Parameter (here called BRANCH) you can reference the parameters set in the Post content parameters section described above. Please note that Branch will need to be extracted from the parameter value because ref is in the payload as eg. refs/heads/master or refs/heads/deploy-test1.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/InputParamBitBucket.PNG?version=1&amp;modificationDate=1601996393963&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
            <li>
                <p>In the Jenkinsfile to extract the Branch from the BRANCH input value, add the following to the environment section:</p><pre class="syntaxhighlighter-pre" xml:space="preserve">BRANCH="${params.BRANCH}".substring("${params.BRANCH}".lastIndexOf("/") + 1, "${params.BRANCH}".lastIndexOf("\""))
				PIPELINE="${BRANCH}"</pre>
            </li>
            <li>
                <p>Finally you will need to add your trigger to the GitHub SQL repository. Go to the specific SQL Repository → Settings → Webhooks → Add webhook</p>
                <ol>
                    <li>
                        <p>Payload URL will be eg. <a class="external-link" href="http://dunder-mifflin.datical.net:8080/generic-webhook-trigger/invoke?token=abc" rel="nofollow">http://dunder-mifflin.datical.net:8080/generic-webhook-trigger/invoke?token=abc</a></p>
                    </li>
                    <li>
                        <p>Content type: application/json</p>
                    </li>
                    <li>
                        <p>Configure which events you would like to trigger the webhook</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/WebhookBitbucket.PNG?version=1&amp;modificationDate=1601996507459&amp;cacheVersion=1&amp;api=v2" /></span>
                    </li>
                </ol>
            </li>
            <li>
                <p>Test your webhook setup by making a change to the desired branch and check if the webhook shows a Successful Delivery and Jenkins Build is started as expected:</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="https://datical-cs.atlassian.net/wiki/download/attachments/1223491670/BitbucketLastResponse.PNG?version=1&amp;modificationDate=1601996528756&amp;cacheVersion=1&amp;api=v2" /></span>
            </li>
        </ol>
    </body>
</html>